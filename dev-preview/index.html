<!DOCTYPE html>
<html>
  <head>
    <title>TV Subscription Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      /* Responsive container */
      .table-container {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th, td {
        padding: 8px;
        white-space: nowrap;
        text-align: left;
      }

      th {
        background: #333;
        color: white;
        position: sticky;
        top: 0;
        z-index: 2;
      }

      /* Drag handle */
      .handle {
        cursor: grab;
        margin-left: 6px;
        font-size: 14px;
        user-select: none;
      }

      .handle:active {
        cursor: grabbing;
      }

      tr:nth-child(even) {
        background: #f2f2f2;
      }

      @media (max-width: 480px) {
        table {
          font-size: 12px;
        }
        th, td {
          padding: 6px;
        }
      }

      /* Center popup */
      #editPopup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
        z-index: 999;
      }
    </style>
  </head>

  <body>

    <!-- LOGIN SECTION -->
    <h2>Login</h2>
    <input id="email" placeholder="Email" />
    <br /><br />
    <input id="password" type="password" placeholder="Password" />
    <br /><br />
    <button onclick="login()">Login</button>

    <hr />

    <!-- MAIN APPLICATION -->
    <div id="appSection" style="display:none">
      <button onclick="logout()">Logout</button>
      <span id="userInfo"></span>
      <hr />

      <h3>Add Customer</h3>
      <input id="name" placeholder="Customer Name" />
      <input id="mobile" placeholder="Mobile" />
      <input id="vc" placeholder="VC Number" />
      <input id="stb" placeholder="STB Serial Number" />
      <input id="product" placeholder="Product" />
      <input id="end" type="date" />
      <button onclick="addCustomer()">Add</button>

      <h3>Customers</h3>

      <div class="table-container">
        <table border="1" cellpadding="6">
          <thead>
            <tr id="tableHeaderRow">
              <th># <span class="handle" draggable="true">⠿</span></th>
              <th>Name <span class="handle" draggable="true">⠿</span></th>
              <th>Mobile <span class="handle" draggable="true">⠿</span></th>
              <th>VC Number <span class="handle" draggable="true">⠿</span></th>
              <th>STB Serial <span class="handle" draggable="true">⠿</span></th>
              <th>Product <span class="handle" draggable="true">⠿</span></th>
              <th>End Date <span class="handle" draggable="true">⠿</span></th>
              <th>Remaining Days <span class="handle" draggable="true">⠿</span></th>
              <th>Edit <span class="handle" draggable="true">⠿</span></th>
            </tr>
          </thead>
          <tbody id="list"></tbody>
        </table>
      </div>

      <!-- EDIT POPUP -->
      <div id="editPopup">
        <h3>Edit End Date</h3>
        <input type="date" id="editEndDate" />
        <br /><br />
        <button onclick="saveEndDate()">Save</button>
        <button onclick="closePopup()">Cancel</button>
      </div>

    </div>

    <script>
      /* ======================================================
          SUPABASE CLIENT
      ====================================================== */
      const supabaseClient = supabase.createClient(
        "https://fkyarkyvkjouvhoveopd.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZreWFya3l2a2pvdXZob3Zlb3BkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MjUzNzYsImV4cCI6MjA4MjUwMTM3Nn0.36JORrel7jwRR_qfOhMoJKN9PxqUV150cFe7D6DB6dM"
      );

      /* ======================================================
          LOGIN (email + password)
      ====================================================== */
      async function login() {
        const email = email.value;
        const password = password.value;

        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email,
          password,
        });

        if (error) {
          alert(error.message);
          return;
        }

        alert("Login successful!");
        showUser();
        loadCustomers();
      }

      async function logout() {
        await supabaseClient.auth.signOut();
        location.reload();
      }

      async function showUser() {
        const { data } = await supabaseClient.auth.getUser();
        if (data.user) {
          userInfo.innerText = `Logged in as ${data.user.email}`;
          appSection.style.display = "block";
        }
      }

      /* ======================================================
          ADD CUSTOMER
      ====================================================== */
      async function addCustomer() {
        const user = (await supabaseClient.auth.getUser()).data.user;

        const { error } = await supabaseClient.from("customers").insert({
          customer_name: name.value,
          mobile: mobile.value,
          vc_number: vc.value,
          stb_serial_number: stb.value,
          product: product.value,
          service_end_date: end.value,
          user_id: user.id,
        });

        if (error) {
          alert(error.message);
          return;
        }

        loadCustomers();
      }

      /* ======================================================
          LOAD CUSTOMERS
      ====================================================== */
      async function loadCustomers() {
        const { data, error } = await supabaseClient
          .from("customers")
          .select("*")
          .order("service_end_date");

        list.innerHTML = "";
        const today = new Date();

        data.forEach((c, index) => {
          const days = Math.ceil((new Date(c.service_end_date) - today) / 86400000);

          list.innerHTML += `
            <tr>
              <td>${index + 1}</td>
              <td>${c.customer_name}</td>
              <td>${c.mobile}</td>
              <td>${c.vc_number}</td>
              <td>${c.stb_serial_number}</td>
              <td>${c.product}</td>
              <td>${c.service_end_date}</td>
              <td>${days}</td>
              <td><button onclick="editCustomer('${c.id}', '${c.service_end_date}')">Edit</button></td>
            </tr>`;
        });
      }

      window.onload = async () => {
        const { data } = await supabaseClient.auth.getUser();
        if (data.user) {
          showUser();
          loadCustomers();
        }
      };

      /* ======================================================
          EDIT POPUP
      ====================================================== */
      let editingCustomerId = null;

      function editCustomer(id, currentDate) {
        editingCustomerId = id;
        editEndDate.value = currentDate;
        editPopup.style.display = "block";
      }

      function closePopup() {
        editPopup.style.display = "none";
      }

      async function saveEndDate() {
        const newDate = editEndDate.value;

        const { error } = await supabaseClient
          .from("customers")
          .update({ service_end_date: newDate })
          .eq("id", editingCustomerId);

        if (error) {
          alert(error.message);
          return;
        }

        closePopup();
        loadCustomers();
      }

      /* ======================================================
          DRAG & DROP COLUMN REORDER
      ====================================================== */
      let draggedIndex = null;

      document.addEventListener("dragstart", function (e) {
        if (!e.target.classList.contains("handle")) return;

        const th = e.target.closest("th");
        th.setAttribute("draggable", "true");

        draggedIndex = [...th.parentNode.children].indexOf(th);
      });

      document.addEventListener("dragover", function (e) {
        if (!e.target.closest("th")) return;
        e.preventDefault();
      });

      document.addEventListener("drop", function (e) {
        const targetTh = e.target.closest("th");
        if (!targetTh) return;

        const dropIndex = [...targetTh.parentNode.children].indexOf(targetTh);

        reorderColumns(draggedIndex, dropIndex);

        document
          .querySelectorAll("th[draggable='true']")
          .forEach((th) => th.removeAttribute("draggable"));
      });

      function reorderColumns(from, to) {
        if (from === to) return;

        const headerRow = document.getElementById("tableHeaderRow");

        headerRow.insertBefore(
          headerRow.children[from],
          headerRow.children[to]
        );

        document.querySelectorAll("#list tr").forEach((row) => {
          let cells = row.children;
          row.insertBefore(cells[from], cells[to]);
        });
      }
    </script>
  </body>
</html>
